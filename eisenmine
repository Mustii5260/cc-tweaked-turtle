-- =========================
-- EISEN-TUNNEL TURTLE AUTO 3x3 (FIXED)
-- CC: Tweaked
-- =========================

local TUNNEL_LAENGE = 200
local MIN_FUEL = 200

-- ===== ERZ-LISTE =====
local ores = {
  ["minecraft:iron_ore"] = true,
  ["minecraft:deepslate_iron_ore"] = true,
  ["minecraft:gold_ore"] = true,
  ["minecraft:deepslate_gold_ore"] = true,
  ["minecraft:copper_ore"] = true,
  ["minecraft:deepslate_copper_ore"] = true,
  ["minecraft:coal_ore"] = true,
  ["minecraft:deepslate_coal_ore"] = true,
  ["minecraft:redstone_ore"] = true,
  ["minecraft:deepslate_redstone_ore"] = true,
  ["minecraft:lapis_ore"] = true,
  ["minecraft:deepslate_lapis_ore"] = true,
  ["minecraft:diamond_ore"] = true,
  ["minecraft:deepslate_diamond_ore"] = true,
  ["minecraft:emerald_ore"] = true,
  ["minecraft:deepslate_emerald_ore"] = true
}

local steps = 0

-- ===== GRAB-FUNKTIONEN =====
local function digForward()
  while turtle.detect() do turtle.dig() sleep(0.1) end
end

local function digUp()
  while turtle.detectUp() do turtle.digUp() sleep(0.1) end
end

local function digDownSafe()
  while turtle.detectDown() do turtle.digDown() sleep(0.1) end
end

local function digSide(turn)
  turn()
  digForward()
  turtle.forward()
  digUp()
  digDownSafe()
  turtle.back()
  if turn == turtle.turnLeft then turtle.turnRight() else turtle.turnLeft() end
end

-- ===== 3x3 SCHRITT =====
local function mine3x3Step()
  -- vorwärts
  digForward()
  turtle.forward()

  -- oben
  digUp()

  -- unten (erst NACH dem ersten Schritt!)
  if steps > 0 then
    digDownSafe()
  end

  -- links + rechts
  digSide(turtle.turnLeft)
  digSide(turtle.turnRight)

  steps = steps + 1
end

-- ===== INVENTAR =====
local function inventoryFull()
  for i = 1, 16 do
    if turtle.getItemCount(i) == 0 then return false end
  end
  return true
end

local function dropNonOres()
  for i = 1, 16 do
    turtle.select(i)
    local item = turtle.getItemDetail()
    if item and not ores[item.name] then
      turtle.drop()
    end
  end
end

-- ===== BASE =====
local function goHome()
  turtle.turnLeft()
  turtle.turnLeft()
  for i = 1, steps do
    turtle.forward()
  end
  turtle.turnLeft()
  turtle.turnLeft()
end

local function dumpInventoryDown()
  for i = 1, 16 do
    turtle.select(i)
    turtle.dropDown()
  end
end

-- ===== FUEL =====
local function refuelFromChest()
  turtle.turnLeft()
  turtle.suck(64)
  turtle.turnRight()
  for i = 1, 16 do
    turtle.select(i)
    turtle.refuel()
  end
end

local function ensureFuel()
  if turtle.getFuelLevel() < MIN_FUEL then
    print("Fuel niedrig – tanke")
    goHome()
    refuelFromChest()
  end
end

-- ===== START =====
print("Starte ECHTEN 3x3 Eisen-Tunnel ⛏️")

for i = 1, TUNNEL_LAENGE do
  mine3x3Step()
  dropNonOres()
  ensureFuel()

  if inventoryFull() then
    print("Inventar voll – Base")
    goHome()
    dumpInventoryDown()
  end
end

goHome()
dumpInventoryDown()
print("Fertig ✅")
